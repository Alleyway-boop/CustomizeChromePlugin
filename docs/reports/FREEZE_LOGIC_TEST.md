# 冻结逻辑修复测试方案

## 🎯 测试目标
验证修复后的冻结逻辑能够正确处理以下场景：
1. 使用中的页面不会被误冻结
2. 访问页面时倒计时能够正确重置

## 📋 测试场景

### 场景1: 使用中页面防冻结测试
**步骤**:
1. 打开多个网页，包括一些长时间不活动的页面
2. 在某个页面上进行持续操作（滚动、点击、输入等）
3. 设置较短的冻结时间（如1-2分钟）便于测试
4. 观察正在使用的页面是否会被冻结

**预期结果**:
- ✅ 正在使用的页面不应该被冻结
- ✅ 控制台应该看到 "Skipping freeze check for active/visible tab" 的日志
- ✅ 活动页面的剩余时间应显示为 "Active" 或类似状态

### 场景2: 访问页面倒计时重置测试
**步骤**:
1. 打开一个页面，让其显示倒计时（如15分钟）
2. 等待几分钟，观察倒计时减少
3. 点击回到该页面或进行交互操作
4. 观察倒计时是否重置为初始值

**预期结果**:
- ✅ 页面获得焦点时，倒计时应该重置
- ✅ 控制台应该看到 "Reset countdown due to tab activation/window focus/user activity" 的日志
- ✅ UI中的剩余时间应该显示重置后的值

### 场景3: 多种活动检测机制测试
**步骤**:
1. 测试页面滚动是否重置倒计时
2. 测试页面点击是否重置倒计时
3. 测试键盘输入是否重置倒计时
4. 测试窗口焦点切换是否重置倒计时
5. 测试单页应用路由变化是否重置倒计时

**预期结果**:
- ✅ 所有活动类型都应该触发倒计时重置
- ✅ 控制台应该显示相应的活动检测日志
- ✅ 活动节流机制应该正常工作（避免过于频繁的重置）

### 场景4: Page Visibility API 测试
**步骤**:
1. 打开多个标签页
2. 在不同标签页之间切换
3. 最小化浏览器窗口再恢复
4. 使用快捷键切换窗口

**预期结果**:
- ✅ 页面可见性状态应该正确更新
- ✅ 可见页面不应该被冻结
- ✅ 隐藏页面的倒计时应该继续计算

## 🔍 调试信息

### 关键日志消息
修复后应该能看到以下类型的日志：

```javascript
// 活动页面保护
"Skipping freeze check for active/visible tab 123: {active: true, visible: true, url: '...'}"

// 倒计时重置
"Reset countdown due to tab activation for tab 123: {...}"
"Reset countdown due to window focus for tab 123: {...}"
"User activity detected: click"
"Scroll activity detected"

// 页面可见性变化
"Page became visible: {tabId: 123, url: '...'}"
"Page became hidden: {tabId: 123, url: '...'}"
```

### 错误处理日志
应该能看到适当的错误处理：
```javascript
"Error in checkAndFreezeTabs: ..."
"Failed to get page info from content script, using tab data: ..."
```

## ⚡ 性能验证

### 资源使用检查
1. 打开浏览器开发者工具
2. 观察CPU和内存使用情况
3. 确认没有过多的定时器累积
4. 验证事件监听器正常工作

### 活动检测节流验证
1. 快速连续进行用户操作
2. 确认倒计时重置有适当的节流（5秒一次）
3. 滚动事件有2秒节流
4. 避免过度的性能消耗

## 📊 成功标准

### 必须通过的功能测试
- [ ] 使用中的页面不会被冻结
- [ ] 访问页面时倒计时重置
- [ ] 多种用户交互都能触发重置
- [ ] Page Visibility API 正常工作
- [ ] 错误处理机制完善

### 性能要求
- [ ] 没有内存泄漏
- [ ] CPU使用合理
- [ ] 事件监听器有适当的节流
- [ ] 日志输出清晰有用

## 🚀 测试执行

### 快速验证步骤
1. 设置冻结时间为1分钟
2. 打开3-4个网页
3. 在其中一个页面持续操作
4. 等待2分钟观察结果
5. 切换到其他页面验证重置功能

### 详细验证步骤
按照上述4个场景逐一测试，记录所有观察到的行为和日志信息。

## 🔧 故障排除

### 常见问题
1. **页面仍然被冻结**: 检查Page Visibility API状态
2. **倒计时不重置**: 检查事件监听器是否正常工作
3. **性能问题**: 检查节流机制是否生效
4. **日志过多**: 调整日志级别或移除调试信息

### 修复建议
如果测试发现问题，应该：
1. 检查控制台日志
2. 验证事件监听器是否正确注册
3. 确认定时器是否正常运行
4. 测试不同的浏览器和场景